<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - {{ settings.school_name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" id="mobileMenuToggle">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <i class="fas fa-graduation-cap"></i>
            <h5>{{ settings.school_name }}</h5>
            <small>{{ user_role|upper }}</small>
        </div>
        
        <a href="{{ url_for('index') }}">
            <i class="fas fa-home"></i> Halaman Utama
        </a>
        <a href="{{ url_for('dashboard') }}" class="active">
            <i class="fas fa-tachometer-alt"></i> Dashboard
        </a>
        
        {% if user_role in ['admin', 'super_admin'] %}
        <a href="#students">
            <i class="fas fa-users"></i> Data Siswa
        </a>
        {% endif %}
        
        <a href="#attendance">
            <i class="fas fa-clipboard-list"></i> Data Absensi
        </a>
        <a href="#today">
            <i class="fas fa-calendar-day"></i> Absensi Hari Ini
        </a>
        
        {% if user_role in ['admin', 'super_admin'] and settings.enable_leave %}
        <a href="#leaves">
            <i class="fas fa-file-medical"></i> Pengajuan Izin
        </a>
        {% endif %}
        
        {% if user_role in ['admin', 'super_admin', 'teacher'] %}
        <a href="#export">
            <i class="fas fa-download"></i> Export Data
        </a>
        {% endif %}
        
        {% if user_role == 'super_admin' %}
        <hr>
        <a href="{{ url_for('admin_settings') }}">
            <i class="fas fa-cog"></i> Pengaturan
        </a>
        <a href="{{ url_for('manage_users') }}">
            <i class="fas fa-user-shield"></i> Kelola User
        </a>
        {% endif %}
        
        <hr>
        <a href="#change-password">
            <i class="fas fa-key"></i> Ganti Password
        </a>
        <a href="{{ url_for('logout') }}">
            <i class="fas fa-sign-out-alt"></i> Logout
        </a>
        
        <div class="sidebar-footer">
            Absensiweb v3.2
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="page-header">
            <div>
                <h2><i class="fas fa-tachometer-alt"></i> Dashboard</h2>
                <p>Selamat datang, <strong>{{ session.username }}</strong>!</p>
            </div>
            <div class="clock" id="live-clock"></div>
        </div>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else 'warning' if category == 'warning' else 'success' if category == 'success' else 'info' }}">
                        <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'exclamation-circle' if category == 'warning' else 'check-circle' if category == 'success' else 'info-circle' }}"></i>
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="stat-card dark">
                    <div class="stat-icon"><i class="fas fa-users"></i></div>
                    <h6>Total Siswa</h6>
                    <div class="stat-number">{{ total_students }}</div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card success">
                    <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                    <h6>Hadir Hari Ini</h6>
                    <div class="stat-number">{{ total_present }}</div>
                    {% if total_students > 0 %}
                    <div class="progress">
                        <div class="progress-bar" style="width: {{ (total_present / total_students * 100) }}%"></div>
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card danger">
                    <div class="stat-icon"><i class="fas fa-times-circle"></i></div>
                    <h6>Tidak Hadir</h6>
                    <div class="stat-number">{{ total_absent }}</div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card warning">
                    <div class="stat-icon"><i class="fas fa-clock"></i></div>
                    <h6>Terlambat</h6>
                    <div class="stat-number">{{ late_today }}</div>
                </div>
            </div>
        </div>
        
        {% if pending_leaves|length > 0 and user_role in ['admin', 'super_admin'] %}
        <div class="card" id="leaves">
            <div class="card-header bg-primary">
                <h5><i class="fas fa-file-medical"></i> Pengajuan Izin Menunggu ({{ pending_leaves|length }})</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID Siswa</th>
                                <th>Nama</th>
                                <th>Tanggal</th>
                                <th>Tipe</th>
                                <th>Alasan</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for leave in pending_leaves %}
                            <tr>
                                <td>{{ leave.student_id }}</td>
                                <td>{{ leave.student_name }}</td>
                                <td>{{ leave.date }}</td>
                                <td><span class="badge bg-warning">{{ leave.type|capitalize }}</span></td>
                                <td>{{ leave.reason[:80] }}{% if leave.reason|length > 80 %}...{% endif %}</td>
                                <td>
                                    <form method="POST" action="{{ url_for('approve_leave', leave_id=leave.id) }}" style="display: inline;">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" class="btn btn-success btn-sm">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    </form>
                                    <form method="POST" action="{{ url_for('reject_leave', leave_id=leave.id) }}" style="display: inline;">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" class="btn btn-danger btn-sm">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
        
        {% if user_role in ['admin', 'super_admin'] %}
        <div class="card" id="students">
            <div class="card-header bg-primary">
                <h5><i class="fas fa-users"></i> Data Siswa</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('add_student') }}" class="mb-4">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <input type="text" class="form-control" name="student_id" placeholder="ID Siswa" required>
                        </div>
                        <div class="col-md-4">
                            <input type="text" class="form-control" name="name" placeholder="Nama Siswa" required>
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control" name="class_name" placeholder="Kelas">
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-plus"></i> Tambah
                            </button>
                        </div>
                    </div>
                </form>
                
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nama</th>
                                <th>Kelas</th>
                                {% if settings.enable_qr %}<th>QR Code</th>{% endif %}
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for student in students %}
                            <tr>
                                <td>{{ student.id }}</td>
                                <td>{{ student.name }}</td>
                                <td>{{ student.class or '-' }}</td>
                                {% if settings.enable_qr %}
                                <td>
                                    <a href="{{ url_for('generate_qr', student_id=student.id) }}" class="btn btn-sm btn-primary" target="_blank">
                                        <i class="fas fa-qrcode"></i>
                                    </a>
                                </td>
                                {% endif %}
                                <td>
                                    <form method="POST" action="{{ url_for('delete_student', student_id=student.id) }}" style="display: inline;">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Hapus siswa ini?')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
        
        <div class="card" id="today">
            <div class="card-header bg-primary">
                <h5><i class="fas fa-calendar-day"></i> Absensi Hari Ini ({{ today }})</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nama</th>
                                <th>Waktu</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if present_today %}
                                {% for id, data in present_today.items() %}
                                <tr>
                                    <td>{{ id }}</td>
                                    <td>{{ data.name }}</td>
                                    <td>{{ data.time }}</td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if data.status == 'Hadir' else 'warning' if data.status == 'Terlambat' else 'info' }}">
                                            {{ data.status }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="4" class="text-center text-muted">Belum ada absensi hari ini</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        {% if user_role in ['admin', 'super_admin', 'teacher'] %}
        <div class="card" id="export">
            <div class="card-header bg-primary">
                <h5><i class="fas fa-download"></i> Export Data Absensi</h5>
            </div>
            <div class="card-body text-center">
                <p class="text-muted mb-4">Ekspor semua data absensi</p>
                <a href="{{ url_for('export_csv') }}" class="btn btn-success btn-lg me-2">
                    <i class="fas fa-file-csv"></i> CSV
                </a>
                <a href="{{ url_for('export_excel') }}" class="btn btn-primary btn-lg">
                    <i class="fas fa-file-excel"></i> Excel
                </a>
            </div>
        </div>
        {% endif %}
        
        <div class="card" id="attendance">
            <div class="card-header bg-primary">
                <h5><i class="fas fa-clipboard-list"></i> Riwayat Absensi (7 Hari)</h5>
            </div>
            <div class="card-body">
                {% set shown = namespace(count=0) %}
                {% for date, records in attendance.items()|reverse %}
                    {% if shown.count < 7 %}
                        <h6 class="mt-3"><i class="fas fa-calendar"></i> {{ date }}</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Nama</th>
                                        <th>Waktu</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for id, data in records.items() %}
                                    <tr>
                                        <td>{{ id }}</td>
                                        <td>{{ data.name }}</td>
                                        <td>{{ data.time }}</td>
                                        <td>
                                            <span class="badge bg-{{ 'success' if data.status == 'Hadir' else 'warning' if data.status == 'Terlambat' else 'info' }}">
                                                {{ data.status }}
                                            </span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% set shown.count = shown.count + 1 %}
                    {% endif %}
                {% endfor %}
            </div>
        </div>
        
        <div class="card" id="change-password">
            <div class="card-header bg-primary">
                <h5><i class="fas fa-key"></i> Ganti Password</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('change_password') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Password Saat Ini</label>
                            <input type="password" class="form-control" name="current_password" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Password Baru (min. 6)</label>
                            <input type="password" class="form-control" name="new_password" required minlength="6">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Konfirmasi</label>
                            <input type="password" class="form-control" name="confirm_password" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-warning mt-3">
                        <i class="fas fa-save"></i> Ganti Password
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Mobile menu toggle
        const menuToggle = document.getElementById('mobileMenuToggle');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');
        
        menuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        });
        
        overlay.addEventListener('click', () => {
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
        });
        
        // Close sidebar when clicking a link on mobile
        document.querySelectorAll('.sidebar a').forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth <= 768) {
                    sidebar.classList.remove('active');
                    overlay.classList.remove('active');
                }
            });
        });
        
        // Live clock
        function updateClock() {
            const now = new Date();
            const time = now.toLocaleTimeString('id-ID');
            document.getElementById('live-clock').textContent = time;
        }
        setInterval(updateClock, 1000);
        updateClock();
        
        // Smooth scroll
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            });
        });
    </script>
</body>
</html>
